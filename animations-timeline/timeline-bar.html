<!-- <link href="../../components/polymer-flex-layout/polymer-flex-layout.html" rel="import"> -->
<polymer-element name="timeline-bar" attributes="model xscale parentx">
	<template>
		<style>
			:host {
				display: block;
				margin: 5px 0;
			}
			.svg-fit {
				position: absolute;
				top: 0;
				left: 0;
				right: -25px;
				width: 100%;
				height: 25px;
			}
			#expandBtn {
				display: inline-block;
				width: 22px;
			}
			#bar-container {
				position: relative;
			}
			#bar-container.selected {
				border: 1px solid red;
			}
			#bar {
				display: inline-block;
				box-sizing: border-box;
				width: {{width}}px;
				height: 25px;
				-webkit-transform: translateX({{x}}px);
				padding: 4px;
				font-size: 14px;
				position: relative;
			}
			#bar-container > div {
				background-color: salmon;
			}
			#bar-container.pargroup > div {
				background-color: lightblue;
			}
			#bar-container.seqgroup > div {
				background-color: lightgreen;
			}
			#fillBackwards, #fillForwards {
				opacity: 0.4;
				position: absolute;
				top: 0;
				bottom: 0;
				display: inline-block;
				box-sizing: border-box;
				height: 25px;
			}
			#fillBackwards[hidden], #fillForwards[hidden] {
				opacity: 0;
			}
			#fillBackwards {
				left: 0;
				width: {{x}}px;
			}
			#fillForwards {
				left: {{end}}px;
				right: 0;
			}
			#timing line, #timing path {
				fill: none;
				stroke: white;
				stroke-width: 1px;
			}
		</style>
		<div>
			<polymer-flex-layout></polymer-flex-layout>
			<template if="{{model.animation.type}}">
				<span id="expandBtn" on-click="{{toggleExpandedAction}}"><template if="{{model.expanded}}">&#x25be;</template><template if="{{!model.expanded}}">&#x25b8;</template></span>
			</template>
			<template if="{{!model.animation.type}}">
				<span id="expandBtn" on-click="{{toggleExpandedAction}}">&nbsp;</span>
			</template>
			<div id="bar-container" flex class="{{ {pargroup: model.animation.type === 'par', seqgroup: model.animation.type === 'seq', selected: selected} | tokenList }}" on-click="{{clickAction}}">
				<div id="fillBackwards" hidden?="{{!fillBackwards}}"></div>
				<div id="bar">
					<template if="{{model.animation.specified.easing === 'linear'}}">
						<svg id="timing" class="svg-fit">
							<line x1="0" y1="100%" x2="100%" y2="0"></line>
						</svg>
					</template>
					<template if="{{model.animation.specified.easing === 'ease-in'}}">
						<svg id="timing" class="svg-fit">
							<path d="{{bezier}}"></path>
						</svg>
					</template>
					<template if="{{model.animation.specified.easing === 'ease-out'}}">
						<svg id="timing" class="svg-fit">
							<path d="{{bezier}}"></path>
						</svg>
					</template>
					<template if="{{model.animation.specified.easing === 'ease-in-out'}}">
						<svg id="timing" class="svg-fit">
							<path d="{{bezier}}"></path>
						</svg>
					</template>
					{{model.animation.type}} {{model.animation.children.length}}
				</div>
				<div id="fillForwards" hidden?="{{!fillForwards}}"></div>
			</div>
		</div>
		<template if="{{model.expanded}}">
			<template repeat="{{c in model.children}}">
				<timeline-bar model="{{c}}" xscale="{{xscale}}" parentx="{{x}}"></timeline-bar>
			</template>
		</template>
	</template>
	<script>
		Polymer('timeline-bar', {
			parentx: 0,
			fillBackwards: false,
			fillForwards: false,
			selected: false,
			observe: {
				'model.animation.activeDuration': 'modelChanged',
			},
			modelChanged: function() {
				this.width = this.xscale(this.model.animation.activeDuration);
				this.x = this.parentx + this.xscale(this.model.animation.startTime + this.model.animation.specified.delay);
				this.end = this.xscale(this.model.animation.endTime);
				var specified = this.model.animation.specified;
				// fill
				if (specified.fill === 'backwards') {
					this.fillBackwards = true;
					this.fillForwards = false;
				} else if (specified.fill === 'forwards') {
					this.fillBackwards = false;
					this.fillForwards = true;
				} else if (specified.fill === 'both') {
					this.fillBackwards = true;
					this.fillForwards = true;
				} else {
					this.fillBackwards = false;
					this.fillForwards = false;
				}
				if (specified.easing === 'ease-in') {
					this.bezier = 'M0 25 C ' + (0.42 * this.width) + ' 25, ' + this.width + ' 0, ' + this.width + ' 0';
				} else if (specified.easing === 'ease-out') {
					this.bezier = 'M0 25 C 0 25, ' + (0.58 * this.width) + ' 0, ' + this.width + ' 0';
				} else if (specified.easing === 'ease-in-out') {
					this.bezier = 'M0 25 C ' + (0.42 * this.width) + ' 25, ' + (0.58 * this.width) + ' 0, ' + this.width + ' 0';
				}
			},
			toggleExpandedAction: function() {
				this.fire('timeline-bar-toggle-expand', this.model);
			},
			clickAction: function() {
				this.selected = !this.selected;
				this.fire('timeline-bar-click', this);
			}
		});
	</script>
</polymer-element>
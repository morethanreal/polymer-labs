<!-- <link href="../../components/polymer-animation/web-animations.html" rel="import"> -->
<link href="timeline-bar.html" rel="import">
<polymer-element name="animations-timeline" attributes="animation">
	<template>
		<style>
			#selectedRect {
				display: none;
				position: fixed;
				border: 1px solid red;
				background-color: red;
				opacity: 0.4;
				top: {{selectedRect.top}}px;
				left: {{selectedRect.left}}px;
				width: {{selectedRect.width}}px;
				height: {{selectedRect.height}}px;
				z-index: 100;
			}
			#selectedRect.selected {
				display: block;
			}
		</style>
		<div id="container">
			<timeline-bar model="{{model}}" xscale="{{x}}" on-timeline-bar-toggle-expand="{{expandAction}}" on-timeline-bar-click="{{clickAction}}"></timeline-bar>
		</div>
		<div id="selectedRect" class="{{ {selected: selectedRect} | tokenList }}"></div>
	</template>
	<script>
		Polymer('animations-timeline', {
			depth: 0,
			animation: null,
			ready: function() {
				this.animation = new ParGroup([
					new SeqGroup([
						new Animation(null, [{opacity: 1}, {opacity: 0}], {duration: 1, easing: 'ease-in'}),
						new Animation(null, [{opacity: 0}, {opacity: 1}], {duration: 2, delay: 1, easing: 'ease-out'})
					], {easing: 'linear'}),
					new Animation(null, [{opacity: 0}, {opacity:1}], {duration: 3, easing: 'ease-in-out'})
				], {easing: 'linear'});
			},
			enteredView: function() {
				var rect = this.getBoundingClientRect();
				this.width = rect.width - 32 - 23;
				this.x = d3.scale.linear().range([0, this.width]);
				this.y = 25;
				this.xAxis = d3.svg.axis().scale(this.x).orient('top');
			},
			animationChanged: function() {
				d3.select(this.$.timeline).selectAll('*').remove();
				this.x.domain([this.animation.startTime, this.animation.endTime]);
				d3.select(this.$.xAxis).call(this.xAxis);
				this.index = 0;
				this.buildModel(this.animation);
				console.log('animation', this.animation);
			},
			depthChanged: function() {
				d3.select(this.$.timeline).selectAll('*').remove();
				this.index = 0;
			},
			buildModel: function(anim) {
				this.model = {
					animation: this.animation,
					expanded: false
				}
			},
			expandAction: function(e, detail, sender) {
				var animation = detail;
				animation.expanded = !animation.expanded;
				if (animation.expanded) {
					animation.children = [];
					Array.prototype.forEach.call(animation.animation.children, function(c) {
						animation.children.push({
							animation: c,
							expanded: false
						});
					});
				} else {
					animation.children = null;
				}
			},
			clickAction: function(e, detail, sender) {
				console.log('click', detail, detail.selected);
				if (this.selectedItem && this.selectedItem.selected && this.selectedItem !== detail) {
					this.selectedItem.selected = false;
				}
				this.selectedItem = detail;
				if (detail.selected && detail.model.animation.target) {
					this.selectedRect = detail.model.animation.target.getBoundingClientRect();
				} else {
					this.selectedRect = null;
				}
			}
		});
	</script>
</polymer-element>
